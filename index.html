<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSFS - Fly 3D online</title>
    <style> 
        body { margin: 0; } 
        /* Popup container - can be anything you want */
.popup {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Popup content */
.popup-content {
    background-color: #fefefe;
    margin: 15% auto; /* 15% from the top and centered */
    padding: 20px;
    border: 1px solid #888;
    width: 80%; /* Could be more or less, depending on screen size */
}
#selectPlaneButton:hover{
    cursor:pointer;
background-color: darkgrey;
}
/* Close button */
.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}
    #popup {
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        display:none;
    }
    #popup-content{
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }

    #close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    #close:hover,
    #close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    #bottomBar{
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #d3d3d3;
        color: #000;
        padding: 10px;
    }
    #crashMessage{
        position: fixed;
        z-index: 1;
        left: 50%;
        top: 50%;
        width: 40%;
        height: 40%;
        overflow: auto;
        background-color: white;
        display: none;
    }
    @keyframes breath{
        0%{
            transform:scale(1);
        }
        50%{
            transform:scale(1.3);
        }
        100%{
            transform:scale(1);
        }
    }
    body{
        font-family: Arial, sans-serif;
    }
    #title{
        left:20%;
        top:0;
        color:#000;
        position:absolute;
        width:100%;
    }
    </style>
</head>
<body>
    <div id="bottomBar"><button id="selectPlaneButton" style="border:none;background-color: #00000000;font-size:20px;color:#000;">AIRCRAFT</button></div>
    
<div id="popup">
    <div id="popup-content">
    <h1>JSFS 3D Flight simulator</h1>
    <h2>NOTE: This flight simulator is <b>in testing and isn't done yet</b>. Check back later to see better graphics and scenery</h2>
    <button onclick="changePopup()">START</button>
    </div>
</div>
<div id="crashMessage" style="display:none;">
    <h1>You crashed!</h1>
    <img src="https://media.tenor.com/x8v1oNUOmg4AAAAM/rickroll-roll.gif" width="200">
    <button onclick="window.location.reload()" style="font-size:100px;animation:breathe 1s infinite;"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" /></button>
</div>
<h1 id="title">JSFS 3D Flight Simulator</h1>
<div id="planePopup" class="popup">
    <div class="popup-content">
        <span class="close">&times;</span>
        <h2>Select Plane Model</h2> 
        <ul>
                <li><button class="plane-option" data-model="./Assets/glTF/low_poly_boeing_787-8/scene.gltf">Boeing 787-8 (Jetstar)</button></li>
            <li><button class="plane-option" data-model="./Assets/glTF/eclipse_550_se/scene.gltf">Eclipse 550 Se</button></li>
            <li><button class="plane-option" data-model="./Assets/glTF/embraer__phenom_300e_ar_v006/scene.gltf">Embraer Phenom</button></li>
            <!--<li><button class="plane-option" data-model="./Assets/glTF/chengdu_j10_vigorous_dragon/scene.gltf">Chengdu J-10 vigorous dragon</button></li>-->
            <li><button>Boeing 747</button><button onclick="document.getElementById('hidden1').style.display='block'">liveries&RightTriangle;</button></li>
            <div id="hidden1" style="display:none;">
                <li><button class="option747" data-model="./Assets/glTF/klm_747_cargo/scene.gltf">KLM Cargo</button></li>
                <li><button class="option747" data-model="./Assets/glTF/boeing_747-44a_ups/scene.gltf">UPS</button></li>
            </div><!--
            <li><button>A320</button><button onclick="document.getElementById('hidden2').style.display='block'">liveries&RightTriangle;</button></li>
            <div id="hidden2" style="display:none;">
                <li><button class="plane-option" data-model="./Assets/glTF/a320neo/scene.gltf">A320neo</button></li>
                <li><button class="plane-option" data-model="./Assets/glTF/airbus_a320/scene.gltf">Airbus A320</button></li>
                <li><button class="plane-option" data-model="./Assets/glTF/airbus_a320_s7_airlines/scene.gltf">Airbus A320neo</button></li>
            </div>-->
            <li><button>Boeing 737</button><button onclick="document.getElementById('hidden3').style.display='block'">liveries&RightTriangle;</button></li>
            <div id="hidden3" style="display:none;">
                <li><button class="option747" data-model="./Assets/glTF/boeing_737_american_airlines/scene.gltf">American Airlines</button></li>
                <li><button class="plane-option" data-model="./Assets/glTF/737_max_lion_air/scene.gltf">Lion air</button></li>
            </div>
            <li><button class="option747" data-model="./Assets/glTF/airbus_a380/scene.gltf">Airbus A380</button>
    </div>
</div>
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script>
        if(localStorage.getItem("popupShown")!="true"){
            document.getElementById("popup").style.display="block";
        }
        var popupContent = document.getElementById("popup-content");
        function changePopup(){
            popupContent.innerHTML=`
            <button id="close">&times;</button>
            <h1>Some instructions before takeoff</h1>
            <h2>Controls:</h2>
            <p>Left and right arrow to roll and yaw left and right</p>
            <p>Keys 0-9 for throttle</p>
            <p>Up and down arrow to pitch up and down</p>
            <p>Click and drag to rotate, and scroll to zoom</p>
            <button onclick="closePopup()">FLY!</button>
            `;
        }
        function closePopup(){
            document.getElementById("popup").style.display="none";
            localStorage.setItem("popupShown", "true");
        }
        const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setClearColor(0x87CEEB);  // Sky blue background color
document.body.appendChild(renderer.domElement);

// Add Ambient Light
const ambientLight = new THREE.AmbientLight(0xffffff, 1.5); // Color, Intensity
scene.add(ambientLight);

// Add a stronger Directional Light
const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
directionalLight.position.set(0, 5, 5).normalize();
scene.add(directionalLight);

// Create the terrain (simple plane with a grass texture)
const terrainGeometry = new THREE.PlaneGeometry(10000, 10000, 32, 32);
const textureLoader = new THREE.TextureLoader();
textureLoader.load('./Assets/img/texture.png', function(texture) {
    const terrainMaterial = new THREE.MeshLambertMaterial({ map: texture });
    const terrain = new THREE.Mesh(terrainGeometry, terrainMaterial);
    terrain.rotation.x = -Math.PI / 2; // Rotate the plane to make it horizontal
    terrain.position.y = 0; // Ensure the plane is at ground level
    scene.add(terrain);
    console.log('Terrain added to the scene');
}, undefined, function(error) {
    console.error('Error loading texture:', error);
});


        // Create mountains using cone geometry
        function createMountain(x, z) {
            const mountainGeometry = new THREE.ConeGeometry(5, 5, 32);
            const mountainMaterial = new THREE.MeshLambertMaterial({ color: 0x8B4513 }); // Brown color for mountains
            const mountain = new THREE.Mesh(mountainGeometry, mountainMaterial);
            mountain.position.set(x, 0, z);
            scene.add(mountain);
        }
        createMountain(-20, -20);
        createMountain(30, -10);
        createMountain(10, 10);

        // Create a runway
        function createRunway(x, z) {
            const runwayGeometry = new THREE.PlaneGeometry(5, 50);
            const runwayMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 }); // Dark grey for the runway
            const runway = new THREE.Mesh(runwayGeometry, runwayMaterial);
            runway.rotation.x = -Math.PI / 2; // Rotate the runway to be flat on the ground
            runway.position.set(x, 0.01, z); // Slightly above the terrain to avoid z-fighting
            scene.add(runway);
        }
        createRunway(0, 0);
        createRunway(-10, 20);

        let model;
        let throttle = 0; // Initialize throttle at 0%
        const cameraOffset = new THREE.Vector3(0, 3, 10); // Offset for the camera relative to the model

        const loader = new THREE.GLTFLoader();
        function applyTextureToLargePlane(model, texturePath) {
    const textureLoader = new THREE.TextureLoader();
    textureLoader.load(texturePath, function(texture) {
        model.traverse(function(child) {
            if (child.isMesh) {
                child.material.map = texture;
                child.material.needsUpdate = true;
            }
        });
    }, undefined, function(error) {
        console.error('Error loading texture:', error);
    });
}

        loader.load('./Assets/glTF/embraer__phenom_300e_ar_v006/scene.gltf', function (gltf) {
            model = gltf.scene;
            model.rotation.y = Math.PI / 1;  // 90 degrees yaw
            model.rotation.x = 0;
            model.position.z = 25;
            model.position.y=1;
            model.scale.set(0.4, 0.4, 0.4);
            scene.add(model);
        }, undefined, function (error) {
            console.error(error);
        });
        document.addEventListener('DOMContentLoaded', () => {
    const selectPlaneButton = document.getElementById('selectPlaneButton');
    const planePopup = document.getElementById('planePopup');
    const closeBtn = document.querySelector('.close');
    const planeOptions = document.querySelectorAll('.plane-option');
    const sevenOptions = document.querySelectorAll('.option747');

    selectPlaneButton.addEventListener('click', () => {
        planePopup.style.display = 'block';
    });

    closeBtn.addEventListener('click', () => {
        planePopup.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
        if (event.target == planePopup) {
            planePopup.style.display = 'none';
        }
    });

    planeOptions.forEach(option => {
        option.addEventListener('click', (event) => {
            const modelPath = event.target.getAttribute('data-model');
            loadModel(modelPath);
            planePopup.style.display = 'none';
        });
    });
    sevenOptions.forEach(option => {
        option.addEventListener('click', (event) => {
            const modelPath = event.target.getAttribute('data-model');
            load747(modelPath);
            planePopup.style.display = 'none';
        });
    });

    function loadModel(modelPath) {
        if (model) {
            scene.remove(model);
        }
        loader.load(modelPath, function (gltf) {
            model = gltf.scene;
            model.rotation.y = Math.PI / 1;  // 90 degrees yaw
            model.rotation.x = 0;
            model.position.z = 25;
            model.position.y = 1;
            model.scale.set(0.4, 0.4, 0.4);
            scene.add(model);
        }, undefined, function (error) {
            console.error(error);
        });
    }
    function load747(modelPath) {
        if (model) {
            scene.remove(model);
        }
        loader.load(modelPath, function (gltf) {
            model = gltf.scene;
            model.rotation.y = Math.PI / 1;  // 90 degrees yaw
            model.rotation.x = 0;
            model.position.z = 25;
            model.position.y = 1;
            model.scale.set(0.2, 0.2, 0.2);
            scene.add(model);
        }, undefined, function (error) {
            console.error(error);
        });
    }
});



        camera.position.set(0, 3, 28); // Initial camera position

        // Add OrbitControls for camera interaction
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; // Enable damping (inertia)
        controls.dampingFactor = 0.05; // Damping inertia

        // Track key presses
        const controlsSpeed = 0.01; // Increased speed for better control
        const keyState = {};

        document.addEventListener('keydown', (event) => {
            keyState[event.code] = true;
            handleThrottle(event); // Handle throttle key presses
        });

        document.addEventListener('keyup', (event) => {
            keyState[event.code] = false;
        });

        function handleThrottle(event) {
            if (event.code.startsWith('Digit') && event.code !== 'Digit0') {
                throttle = parseInt(event.code.replace('Digit', '')) * 10; // Set throttle to corresponding percentage
            } else if (event.code === 'Digit0') {
                throttle = 0; // Set throttle to 0%
            }
        }

        function updateModelRotation() {
            if (model) {
                if (keyState['ArrowLeft']) {
                    model.rotation.y += controlsSpeed; // Yaw right
                    model.rotation.z -= controlsSpeed; // Roll left
                }
                if (keyState['ArrowRight']) {
                    model.rotation.y -= controlsSpeed; // Yaw left
                    model.rotation.z += controlsSpeed; // Roll right
                }
                if (keyState['ArrowUp']) {
                    model.rotation.x -= controlsSpeed; // Pitch up
                }
                if (keyState['ArrowDown']) {
                    model.rotation.x += controlsSpeed; // Pitch down
                }
                // Apply throttle to move the model forward along the z-axis
                model.translateZ(throttle * 0.003); // Move the model forward
            }
        }
        let isMouseDown = false;

document.addEventListener('mousedown', () => {
isMouseDown = true;
});

document.addEventListener('mouseup', () => {
isMouseDown = false;
});

function updateCameraPosition() {
    if (model && !isMouseDown) {
        // Calculate the desired camera position relative to the model
        const relativeCameraPosition = cameraOffset.clone().applyMatrix4(model.matrixWorld);

        // Smoothly interpolate the camera's position to follow the model
        camera.position.lerp(relativeCameraPosition, 0.03);

        // Ensure the camera is always looking at the model
        camera.lookAt(model.position);

        // Update OrbitControls target to the model's position
        controls.target.copy(model.position);
    }
}
let hasCrashed = false; // Flag to track if the crash alert has been shown

function animate() {
    requestAnimationFrame(animate);

    updateModelRotation(); // Update model rotation based on key presses

    if (!isMouseDown) {
        updateCameraPosition(); // Update camera focus and position relative to the model
    }

    controls.update(); // Update controls

    renderer.render(scene, camera);

    // Check if the model has crashed
    if (model.position.y < 0 && model.position.z < -30 && !hasCrashed) {
        hasCrashed = true; // Set the crash flag to true
        document.getElementById('crashMessage').style.display = 'block'; // Show the crash alert
    }

    // Debugging logs
    console.log(`Model position: y=${model.position.y}, z=${model.position.z}`);
}
animate();
    </script>
</body>
</html>